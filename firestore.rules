rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Global counter - anyone can read, increment only
    match /Global/totalusers {
      allow read: if true;
      allow update: if request.resource.data.count == resource.data.count + 1;
      allow create: if true;
    }

    // Auth collection - allow authentication flow
    match /Auth/{docId} {
      // Allow creating auth records (for initial authentication)
      allow create: if true;
      // Allow reading auth records (for checking authentication status)
      allow read: if true;
      // Allow updates for status changes
      allow update: if true;
      // No deletions
      allow delete: if false;
    }

    // Users collection - allow user creation and access
    match /Users/{userId} {
      // Allow user creation (during registration)
      allow create: if true;
      // Allow reading own user data
      allow read: if true;
      // Allow updates (for game progress)
      allow update: if true;
      // No deletions
      allow delete: if false;

      // Actions subcollection
      match /Actions/{actionId} {
        allow create: if true;  // Allow logging actions
        allow read: if true;    // Allow reading actions
        allow update: if true;  // Allow updating actions
        allow delete: if false;
      }

      // Orders subcollection
      match /Orders/{orderId} {
        allow create: if true;  // Allow creating orders
        allow read: if true;    // Allow reading orders
        allow update: if true;  // Allow updating order status
        allow delete: if false;
      }
    }

    // Configs collection - for experiment configurations
    match /Configs/{configId} {
      allow read: if true;
      allow create: if true;
      allow update: if true;
      allow delete: if true;
    }

    // MasterData collection - for game data (centralConfig, orders, stores, experiments, etc.)
    match /MasterData/{docId} {
      allow read: if true;
      allow create: if true;
      allow update: if true;
      allow delete: if true;
    }

    // Block everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
